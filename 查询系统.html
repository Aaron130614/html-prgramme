<!DOCTYPE html>
<html>
<head>
    <title>å›¾ä¹¦ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        body { 
            background-color: #f0f8ff;
            font-family: Arial, sans-serif;
        }
        .section { 
            margin: 20px; 
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .admin-only { display: none; }
        .user-login { display: none; }
        input { 
            margin: 5px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px;
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
        }
        .login-container {
            max-width: 400px;
            margin: 50px auto;
        }
        .role-select {
            margin: 10px 0;
        }
        .danger {
            background-color: #ff4444;
        }
        .danger:hover {
            background-color: #cc0000;
        }
        .book-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .action-column {
            width: 100px;
        }
        .fixed-bottom {
            position: fixed;
            bottom: 20px;
            right: 20px;
        }
        #collectionPage {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .collection-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 300px;
        }
        .export-btn {
            background-color: #2196F3;
            margin-bottom: 10px;
        }
        .delete-collection-btn {
            background-color: #ff4444;
            padding: 5px 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- å›¾ä¹¦å¾é›†æŒ‰é’® -->
    <button class="fixed-bottom" onclick="showCollectionPage()">ğŸ“š å›¾ä¹¦å¾é›†</button>

    <!-- å›¾ä¹¦å¾é›†é¡µé¢ -->
    <div id="collectionPage" class="section">
        <h2>å›¾ä¹¦å¾é›†å»ºè®®</h2>
        <form class="collection-form" onsubmit="submitCollection(event)">
            <select id="userType" required>
                <option value="">è¯·é€‰æ‹©èº«ä»½</option>
                <option value="å­¦ç”Ÿ">æ ¡å†…å­¦ç”Ÿ</option>
                <option value="æ•™å¸ˆ">æ ¡å†…æ•™å¸ˆ</option>
                <option value="æ ¡å¤–">æ ¡å¤–äººå‘˜</option>
            </select>
            
            <input type="text" id="bookTitle" 
                   placeholder="è¯·è¾“å…¥æƒ³çœ‹çš„ä¹¦ç±åç§°ï¼ˆå¿…å¡«ï¼‰" required>
            
            <input type="text" id="bookVersion" 
                   placeholder="è¯·è¾“å…¥ä¹¦ç±ç‰ˆæœ¬ï¼ˆé€‰å¡«ï¼‰">
            
            <button type="submit">æäº¤å»ºè®®</button>
            <button type="button" onclick="hideCollectionPage()">å–æ¶ˆ</button>
        </form>
    </div>

    <!-- ç™»å½•é¡µé¢ -->
    <div class="login-container section" id="loginSection">
        <h2>å›¾ä¹¦ç®¡ç†ç³»ç»Ÿç™»å½•</h2>
        <div class="role-select">
            <label>
                <input type="radio" name="role" value="user" checked> ç”¨æˆ·ç™»å½•
            </label>
            <label>
                <input type="radio" name="role" value="admin"> ç®¡ç†å‘˜ç™»å½•
            </label>
            <label>
                <input type="radio" name="role" value="guest"> æ¸¸å®¢ç™»å½•
            </label>
        </div>

        <div id="userLogin">
            <input type="text" id="userID" placeholder="å­¦å·¥å·">
        </div>
        <div id="adminLogin" style="display: none;">
            <input type="password" id="adminPwd" placeholder="ç®¡ç†å‘˜å¯†ç ">
        </div>
        <button onclick="login()">ç™»å½•</button>
    </div>

    <!-- ä¸»åŠŸèƒ½ç•Œé¢ -->
    <div class="user-login" id="mainContent">
        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="section admin-only" id="fileSection">
            <h2>æ•°æ®å¯¼å…¥ï¼ˆä»…ç®¡ç†å‘˜ï¼‰</h2>
            <div>
                <label>å­¦ç”Ÿä¿¡æ¯æ–‡ä»¶ï¼š
                    <input type="file" id="studentFile" accept=".txt">
                </label>
            </div>
            <div>
                <label>å›¾ä¹¦ä¿¡æ¯æ–‡ä»¶ï¼š
                    <input type="file" id="bookFile" accept=".txt">
                </label>
            </div>
            <button onclick="loadFiles()">å¯¼å…¥æ•°æ®</button>
            <p>æ–‡ä»¶æ ¼å¼è¦æ±‚ï¼š<br>
            å­¦ç”Ÿä¿¡æ¯ï¼šå­¦å·¥å·,å§“åï¼ˆæ¯è¡Œä¸€æ¡ï¼‰<br>
            å›¾ä¹¦ä¿¡æ¯ï¼šä¹¦å,ä½œè€…,æ¶,é¢,æ ¼ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰</p>
        </div>

        <!-- è´¦å·ç®¡ç† -->
        <div class="section admin-only" id="accountSection">
            <h2>è´¦å·ç®¡ç†</h2>
            <input type="text" id="newID" placeholder="æ–°å­¦å·¥å·">
            <input type="text" id="newName" placeholder="çœŸå®å§“å">
            <button onclick="addAccount()">æ·»åŠ è´¦å·</button>
            
            <h3>è´¦å·åˆ—è¡¨</h3>
            <div id="accountList"></div>
            
            <h3>ä¿®æ”¹ç®¡ç†å‘˜å¯†ç </h3>
            <input type="password" id="oldPwd" placeholder="æ—§å¯†ç ">
            <input type="password" id="newPwd" placeholder="æ–°å¯†ç ">
            <button onclick="changeAdminPassword()">ä¿®æ”¹å¯†ç </button>
        </div>

        <!-- å›¾ä¹¦ç®¡ç† -->
        <div class="section admin-only" id="bookManagement">
            <h2>å›¾ä¹¦ç®¡ç†</h2>
            <div class="book-list">
                <table id="bookList">
                    <thead>
                        <tr>
                            <th>ä¹¦å</th>
                            <th>ä½œè€…</th>
                            <th>ä½ç½®</th>
                            <th class="action-column">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="bookListBody"></tbody>
                </table>
            </div>
        </div>

        <!-- å›¾ä¹¦å½•å…¥ -->
        <div class="section admin-only" id="addSection">
            <h2>å½•å…¥å›¾ä¹¦</h2>
            <input type="text" id="bookName" placeholder="ä¹¦å">
            <input type="text" id="author" placeholder="ä½œè€…">
            <input type="number" id="shelf" placeholder="æ¶">
            <input type="number" id="side" placeholder="é¢">
            <input type="number" id="grid" placeholder="æ ¼">
            <button onclick="addBook()">æ·»åŠ å›¾ä¹¦</button>
        </div>

        <!-- å›¾ä¹¦æŸ¥è¯¢ -->
        <div class="section">
            <h2>å›¾ä¹¦æŸ¥è¯¢</h2>
            <input type="text" id="searchKey" placeholder="è¾“å…¥ä¹¦åæˆ–ä½œè€…">
            <button onclick="searchBooks()">æŸ¥è¯¢</button>
            <div id="searchResults"></div>
        </div>

        <!-- æ‰¹é‡åˆ é™¤ -->
        <div class="section admin-only" id="delSection">
            <h2>æ‰¹é‡åˆ é™¤ï¼ˆæŒ‰ä½ç½®ï¼‰</h2>
            <input type="number" id="delShelf" placeholder="æ¶">
            <input type="number" id="delSide" placeholder="é¢">
            <input type="number" id="delGrid" placeholder="æ ¼">
            <button onclick="deleteBooksByLocation()">æ‰¹é‡åˆ é™¤</button>
        </div>

        <!-- å›¾ä¹¦å¾é›†ç»“æœ -->
        <div class="section admin-only" id="collectionResults">
            <h2>å›¾ä¹¦å¾é›†ç»“æœ</h2>
            <button class="export-btn" onclick="exportCollections()">å¯¼å‡ºæ•°æ®</button>
            <div class="book-list">
                <table>
                    <thead>
                        <tr>
                            <th>æäº¤æ—¶é—´</th>
                            <th>èº«ä»½</th>
                            <th>ä¹¦ç±åç§°</th>
                            <th>ç‰ˆæœ¬ä¿¡æ¯</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="collectionList"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
// åˆå§‹åŒ–å­˜å‚¨
(function initStorage(){
    if(!localStorage.getItem('books')) localStorage.setItem('books', JSON.stringify([]));
    if(!localStorage.getItem('users')) localStorage.setItem('users', JSON.stringify([]));
    if(!localStorage.getItem('collections')) localStorage.setItem('collections', JSON.stringify([]));
    if(!localStorage.getItem('adminPwd')) localStorage.setItem('adminPwd', 'xxtsg-gly');
})();

let currentUser = null;
const adminPassword = localStorage.getItem('adminPwd');
let collections = JSON.parse(localStorage.getItem('collections')) || [];

// å›¾ä¹¦å¾é›†åŠŸèƒ½
function showCollectionPage() {
    document.getElementById('collectionPage').style.display = 'block';
}

function hideCollectionPage() {
    document.getElementById('collectionPage').style.display = 'none';
}

function submitCollection(event) {
    event.preventDefault();
    
    const collection = {
        timestamp: new Date().toISOString(),
        type: document.getElementById('userType').value,
        title: document.getElementById('bookTitle').value.trim(),
        version: document.getElementById('bookVersion').value.trim(),
    };

    collections.push(collection);
    localStorage.setItem('collections', JSON.stringify(collections));
    
    alert('æäº¤æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„å»ºè®®');
    hideCollectionPage();
    if(currentUser?.role === 'admin') loadCollections();
}

// åˆ é™¤å¾é›†ä¿¡æ¯åŠŸèƒ½
function deleteCollection(timestamp) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¾é›†ä¿¡æ¯å—ï¼Ÿ')) return;
    
    collections = collections.filter(collection => collection.timestamp !== timestamp);
    localStorage.setItem('collections', JSON.stringify(collections));
    loadCollections();
    alert('åˆ é™¤æˆåŠŸ');
}

// åŠ è½½å¾é›†ç»“æœ
function loadCollections() {
    const tbody = document.getElementById('collectionList');
    tbody.innerHTML = collections.map(item => `
        <tr>
            <td>${new Date(item.timestamp).toLocaleString()}</td>
            <td>${item.type}</td>
            <td>${item.title}</td>
            <td>${item.version || 'æ— '}</td>
            <td>
                <button class="delete-collection-btn" 
                        onclick="deleteCollection('${item.timestamp}')">
                    åˆ é™¤
                </button>
            </td>
        </tr>
    `).join('');
}

// æ•°æ®å¯¼å‡ºåŠŸèƒ½
function exportCollections() {
    if (collections.length === 0) {
        alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
        return;
    }
    
    const dataStr = JSON.stringify(collections, null, 2);
    const blob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `book_collections_${new Date().getTime()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ç™»å½•ç³»ç»Ÿ
document.querySelectorAll('input[name="role"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.getElementById('userLogin').style.display = 
            this.value === 'user' ? 'block' : 'none';
        document.getElementById('adminLogin').style.display = 
            this.value === 'admin' ? 'block' : 'none';
    });
});

function login() {
    const role = document.querySelector('input[name="role"]:checked').value;
    
    if (role === 'admin') {
        const inputPwd = document.getElementById('adminPwd').value;
        if (inputPwd === adminPassword) {
            currentUser = { role: 'admin' };
            showMainInterface();
            loadAccountList();
            loadBookList();
            loadCollections();
        } else {
            alert('ç®¡ç†å‘˜å¯†ç é”™è¯¯');
        }
    } else if (role === 'user') {
        const id = document.getElementById('userID').value;
        const users = JSON.parse(localStorage.users);
        const user = users.find(u => u.id === id);
        user ? (currentUser = user, showMainInterface(), alert(`æ¬¢è¿ ${user.name}`)) 
             : alert('è´¦å·ä¸å­˜åœ¨');
    } else {
        currentUser = { role: 'guest' };
        showMainInterface();
        alert('æ¸¸å®¢æ¨¡å¼ä»…æ˜¾ç¤ºéƒ¨åˆ†ä¿¡æ¯');
    }
}

function showMainInterface() {
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    if (currentUser.role === 'admin') {
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
    }
}

// ä¿æŒå…¶ä»–åŸæœ‰åŠŸèƒ½ä»£ç ä¸å˜
// ...
</script>
</body>
</html>